version: 2
jobs:
  build:
    working_directory: ~/docker_sample
    docker:
      - image: golang:1.8.0
    steps:
      - checkout

      - setup_remote_docker:
          reusable: true

      # This should go into custom primary image, here's only for the sake of explanation
      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.03.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin

      # This should go into custom primary image, here's only for the sake of explanation
      - run:
          name: Install Docker Compose
          command: |
            set -x
            curl -L https://github.com/docker/compose/releases/download/1.11.2/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose

      - run:
          name: Start container
          command: |
            set -x
            cd /root/docker_sample/foobar-server
            docker-compose build
            docker-compose -f docker-compose.yml -f docker-compose-ci.yml up -d homes
            docker cp ../hoge_project/admin_app homes:/home/hoge
            docker cp ../hoge_project/site_app homes:/home/hoge
            docker cp ./mysql_init/01_create_db.sql homes:/docker-entrypoint-initdb.d
            docker cp ./mysql_init/02_import_db.sh homes:/docker-entrypoint-initdb.d
            docker cp ./mysql_init/fuga.dump.gz homes:/docker-entrypoint-initdb.d
            docker cp ./mysql_init/fuga2.dump.gz homes:/docker-entrypoint-initdb.d
            docker cp ./mysql_conf.d/utf8.cnf homes:/etc/mysql/conf.d
            docker-compose -f docker-compose.yml -f docker-compose-ci.yml up -d
            sleep 5
            docker-compose ps
            docker-compose logs
            docker-compose exec php curl --retry 10 --retry-delay 1 http://localhost:80/mysql_sample.php
            docker-compose logs
